<?xml version="1.0"?>

<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
<!-- iText, a JAVA - PDF library                                      -->
<!-- $Id$         -->
<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

<project name="iText.release" default="help">
	
	<property file="local.properties" />
	<property file="${user.home}/.ant.properties" />
	<property file=".ant.properties" />
	
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Help                                                             -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

    <target name="help" description="--> shows the help screen">
        <echo>MAKING A NEW RELEASE (release.xml)</echo>
        <echo>archive.src: archiving the source (zip and tar.gz)</echo>
        <echo>asian.jar: creates a new version of iTextAsian.jar and iTextAsianCmaps.jar</echo>
        <echo />
	</target>

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Archiving the code                                               -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

	<target name="src.zip" description="--> makes a zipfile with the source code">
		<mkdir dir="${itext.dist}"/>
		<zip zipfile="${itext.dist}/src.zip" basedir="${itext.src}" includes="**/*.java, **/*.ps, **/*.txt, **/*.gif, **/*.afm, **/*.html, **/*.xml, ant/.ant.properties" />
	</target>
	
	<target name="src.tar.gz" description="--> makes a tar.gz-file with the source code">
		<mkdir dir="${itext.dist}"/>
		<tar compression="gzip" tarfile="${itext.dist}/src.tar.gz" basedir="${itext.src}" includes="**/*.java, **/*.ps, **/*.txt, **/*.gif, **/*.afm, **/*.html, **/*.xml, ant/.ant.properties" />
	</target>
	
	<target name="src.jar" description="--> makes a jar file with the source code">
		<mkdir dir="${itext.dist}"/>
		<jar destfile="${itext.dist}/iText-${releasenumber}-sources.jar" basedir="${itext.src}" includes="**/*.java, **/*.ps, **/*.txt, **/*.gif, **/*.afm, **/*.html, **/*.xml, ant/.ant.properties" />
	</target>
	
	<target name="archive.src" depends="src.zip, src.tar.gz, src.jar" description="--> archives the source code" />

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Making a release, ready for upload to SourceForge                -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->	
	
	<target name="release.sf" description="--> makes a complete iText release ready to publish on SourceForge">
		<mkdir dir="${itext.sf}"/>
		<copy file="${itext.jar}" todir="${itext.dist}" overwrite="yes" />
		<copy file="${itext.jar}" tofile="${itext.dist}/iText-${releasenumber}.jar" overwrite="yes"/>
		<copy file="${itext.jar}" tofile="${itext.sf}/iText-${releasenumber}.jar" overwrite="yes"/>
		<copy file="${itext.dist}/src.zip" tofile="${itext.sf}/iText-src-${releasenumber}.zip" overwrite="yes"/>
		<copy file="${itext.dist}/src.tar.gz" tofile="${itext.sf}/iText-src-${releasenumber}.tar.gz" overwrite="yes"/>
		<copy file="${itext.dist}/docs.tar.gz" tofile="${itext.sf}/iText-docs-${releasenumber}.tar.gz" overwrite="yes"/>
		<copy file="${itext.dist}/iText-${releasenumber}-sources.jar" tofile="${itext.sf}/iText-${releasenumber}-sources.jar" overwrite="yes"/>
		<copy file="${itext.src}/ant/pom.xml" tofile="${itext.dist}/pom.xml" overwrite="yes"/>
		<replace file="${itext.dist}/pom.xml" token="releasenumber" value="${releasenumber}"/>
		<replace file="${itext.dist}/pom.xml" token="bc.jdk" value="${bc.jdk}"/>
		<replace file="${itext.dist}/pom.xml" token="bc.version" value="${bc.version}"/>
		<jar destfile="${itext.dist}/iText-${releasenumber}-bundle.jar">
			<fileset dir="${itext.dist}">
				<include name="pom.xml" />
				<include name="iText-${releasenumber}.jar" />
				<include name="iText-${releasenumber}-sources.jar" />
			</fileset>
		</jar>
	</target>

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Generates jdiff report against previous version                  -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->	

	<target name="jdiff" description="--> generates jdiff report against previous version">
		<fail unless="JDIFF_HOME" message="JDIFF_HOME must be defined" />
		<fail unless="itext.previous.version" message="itext.previous.version must be defined" />
		<fail unless="itext.previous.location" message="itext.previous.location must be defined" />

		<taskdef name="jdiff" classname="jdiff.JDiffAntTask" classpath="${JDIFF_HOME}/antjdiff.jar" />

		<mkdir dir="${itext.reports}"/>
		<jdiff destdir="${itext.reports}" verbose="on" stats="on" docchanges="on">
			<old name="${itext.previous.version}">
				<dirset dir="${itext.previous.location}/src" includes="com/**" />
			</old>
			<new name="current">
				<dirset dir="${itext.src}" includes="com/**" />
			</new>
		</jdiff>
		<copy file="${itext.reports}/missingSinces.txt"
			tofile="${itext.reports}/missingSinces.err" >

			<filterchain>
				<striplinecomments>
					<comment value="OK: "/>
				</striplinecomments>
			</filterchain>
		</copy>

		<concat>
			<filelist dir="${itext.reports}" files="missingSinces.err"/>
		</concat>

		<fail message="missing @since tags">
			<condition>
				<length file="${itext.reports}/missingSinces.err" when="greater" length="0" />
			</condition>
		</fail>
	</target>

    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <!-- Making the jars with the Asian Fontfiles                         -->
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->	
	<target name="asian.jar" description="--> makes iTextAsian.jar and iTextAsianCmaps.jar">
        <jar jarfile="${itext.lib}/iTextAsian.jar" basedir="${itext.src}" includes="**/*.cmap,**/*.properties,**/cmap_info.txt" excludes="**/.ant.properties" />
        <jar jarfile="${itext.lib}/iTextAsianCmaps.jar" basedir="${itext.src}" includes="com/lowagie/text/pdf/fonts/cmaps/**" />
	</target>

</project>
